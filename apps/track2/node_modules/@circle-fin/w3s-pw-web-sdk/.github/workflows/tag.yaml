name: add-tag

on:
  push:
    branches: [test]

jobs:
  build:
    runs-on: small-spot
    steps:
    - uses: actions/checkout@v4
      with:
        ref: test

    - name: get version of tag
      run: |
        echo NEW_TAG=$(jq .version ./package.json | tr -d '"') >> $GITHUB_ENV

    - name: Read secrets from AWS Secrets Manager into environment variables
      uses: aws-actions/aws-secretsmanager-get-secrets@v2.0.5
      with:
        secret-ids: |
          /ops/utilities/github-actions-bot/gpg-priv-key
          /ops/utilities/github-actions-bot/api-token

    - name: Import GPG key
      id: import-gpg
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        gpg_private_key: ${{ env._OPS_UTILITIES_GITHUB_ACTIONS_BOT_GPG_PRIV_KEY }}
        git_config_global: true
        git_user_signingkey: true
        git_commit_gpgsign: true

    - name: Tag commit
      uses: tvdias/github-tagger@v0.0.1
      with:
        repo-token: "${{ env._OPS_UTILITIES_GITHUB_ACTIONS_BOT_API_TOKEN }}"
        tag: "${{ env.NEW_TAG }}"
