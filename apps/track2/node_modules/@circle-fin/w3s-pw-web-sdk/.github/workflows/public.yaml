name: to-public

on:
  #pull_request:
  #  branches: [master]
  push:
    branches: [master]

jobs:
  sync:
    uses: circlefin/github-shared-pipelines/.github/workflows/repo-file-sync.yaml@v1

  publish:
    runs-on: large-spot
    permissions:
      contents: read
      packages: write
    if: ${{ github.repository == 'circlefin/w3s-pw-web-sdk-internal' }} # Making sure it will run only on @circlefin and not on forks
    steps:
      - name: Read secrets from AWS Secrets Manager into environment variables
        uses: aws-actions/aws-secretsmanager-get-secrets@v2.0.5
        with:
            parse-json-secrets: true
            secret-ids: |
              /ops/utilities/github-actions-bot/ssh-priv-key
              /ops/utilities/github-actions-bot/package-read-token
              /ops/utilities/github-actions-bot/npm-publish-token

      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          cache: 'yarn'
          node-version: 18.x
          registry-url: https://registry.npmjs.com/
          always-auth: true

      - run: yarn install --frozen-lockfile
      - run: yarn config set registry https://registry.npmjs.com/
      - run: npm set //registry.npmjs.com/:_authToken $NPM_AUTH_TOKEN
        env:
          NPM_AUTH_TOKEN: ${{ env._OPS_UTILITIES_GITHUB_ACTIONS_BOT_NPM_PUBLISH_TOKEN }}

      - run: yarn build
      - run: npm publish --access public
